<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.31e3a5973a2c586d7775.css" data-identity="gatsby-global-css">*,:after,:before{box-sizing:border-box}:after,:before{text-decoration:inherit;vertical-align:inherit}html{-webkit-tap-highlight-color:transparent;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;cursor:default;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-break:break-word}body{margin:0}h1{font-size:2em;margin:.67em 0}dl dl,dl ol,dl ul,ol dl,ol ol,ol ul,ul dl,ul ol,ul ul{margin:0}hr{color:inherit;height:0;overflow:visible}main{display:block}nav ol,nav ul{list-style:none;padding:0}nav li:before{content:"\200B"}pre{-ms-overflow-style:scrollbar;font-family:monospace,monospace;font-size:1em;overflow:auto}a{background-color:transparent}abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}audio,canvas,iframe,img,svg,video{vertical-align:middle}audio,video{display:inline-block}audio:not([controls]){display:none;height:0}iframe,img{border-style:none}svg:not([fill]){fill:currentColor}svg:not(:root){overflow:hidden}table{border-collapse:collapse;border-color:inherit;text-indent:0}button,input,select{margin:0}button{overflow:visible;text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}fieldset{border:1px solid #a0a0a0;padding:.35em .75em .625em}input{overflow:visible}legend{color:inherit;display:table;max-width:100%;white-space:normal}progress{display:inline-block;vertical-align:baseline}select{text-transform:none}textarea{margin:0;overflow:auto;resize:vertical;resize:block}[type=checkbox],[type=radio]{padding:0}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}details,dialog{display:block}dialog{background-color:#fff;border:solid;color:#000;height:-moz-fit-content;height:-webkit-fit-content;height:fit-content;left:0;margin:auto;padding:1em;position:absolute;right:0;width:-moz-fit-content;width:-webkit-fit-content;width:fit-content}dialog:not([open]){display:none}summary{display:list-item}canvas{display:inline-block}template{display:none}[tabindex],a,area,button,input,label,select,summary,textarea{-ms-touch-action:manipulation}[hidden]{display:none}[aria-busy=true]{cursor:progress}[aria-controls]{cursor:pointer}[aria-disabled=true],[disabled]{cursor:not-allowed}[aria-hidden=false][hidden]{display:initial}[aria-hidden=false][hidden]:not(:focus){clip:rect(0,0,0,0);position:absolute}.markdown{word-wrap:break-word;text-rendering:optimizeLegibility;background-color:#fdfdfd;color:#1a1a1a;font-family:Georgia,serif;font-kerning:normal;font-size:20px;-webkit-hyphens:auto;-ms-hyphens:auto;hyphens:auto;line-height:1.5;margin:0 auto;max-width:42em;padding:50px}@media (max-width:600px){.markdown{font-size:.9em;padding:1em}}@media print{.markdown{background-color:transparent;color:#000;font-size:12pt}.markdown p,h2,h3{orphans:3;widows:3}.markdown h2,h3,h4{page-break-after:avoid}}.markdown p{margin:1em 0}.markdown a,.markdown a:visited{color:#1a1a1a}.markdown img{display:block;margin:0 auto;max-width:100%}.markdown h1{text-align:center}.markdown h1,h2,h3,h4,h5,h6{margin-top:1.4em}.markdown h5,h6{font-size:1em;font-style:italic}.markdown h6{font-weight:400}.markdown ol,ul{margin-top:1em;padding-left:1.7em}.markdown li>ol,li>ul{margin-top:0}.markdown blockquote{border-left:2px solid #e6e6e6;color:#606060;margin:1em 0 1em 1.7em;padding-left:1em}.markdown code{font-family:Menlo,Monaco,Lucida Console,Consolas,monospace;font-size:85%;margin:0}.markdown pre{margin:1em 0;overflow:auto}.markdown pre code{overflow:visible;padding:0}.markdown .sourceCode{background-color:transparent;overflow:visible}.markdown hr{background-color:#1a1a1a;border:none;height:1px;margin:1em 0}.markdown table{border-collapse:collapse;display:block;font-variant-numeric:lining-nums tabular-nums;margin:1em 0;overflow-x:auto;width:100%}.markdown table caption{margin-bottom:.75em}.markdown tbody{border-bottom:1px solid #1a1a1a;border-top:1px solid #1a1a1a;margin-top:.5em}.markdown th{border-top:1px solid #1a1a1a;padding:.25em .5em}.markdown td{padding:.125em .5em .25em}.markdown header{margin-bottom:4em;text-align:center}.markdown #TOC li{list-style:none}.markdown #TOC a:not(:hover){text-decoration:none}.markdown code{white-space:pre-wrap}.markdown span.smallcaps{font-variant:small-caps}.markdown span.underline{text-decoration:underline}.markdown div.column{display:inline-block;vertical-align:top;width:50%}.markdown div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}.markdown ul.task-list{list-style:none}</style><meta name="generator" content="Gatsby 3.14.3"/><title data-react-helmet="true"></title><style data-styled="" data-styled-version="5.3.3"></style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="icon" href="/favicon-32x32.png?v=96780e3f13c42679ded519d5dd34675e" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=96780e3f13c42679ded519d5dd34675e"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/><link as="script" rel="preload" href="/webpack-runtime-a49788a225b1cf65a998.js"/><link as="script" rel="preload" href="/framework-01c4d90fe68c071f8f36.js"/><link as="script" rel="preload" href="/app-7d6101fda03d10f602f8.js"/><link as="script" rel="preload" href="/component---src-pages-blog-on-chain-js-a342c2415ace82abdc8f.js"/><link as="fetch" rel="preload" href="/page-data/blog/on-chain/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="markdown"><h1>The Lenia on-chain adventure</h1>
<p>Welcome to this little &quot;behind the scenes&quot; story and very first Lenia blog post! üî•</p>
<p>In our effort of being transparent, let&#x27;s not only share the successes but also all the drawbacks, sweat, and tears that filled this Lenia journey!</p>
<p><img src="./no-pain-no-gain.gif" alt="No pain no gain"/></p>
<h2>TL;DR</h2>
<ul>
<li>We set a release date a little bit too early and due to the team organization and a few surprises, we were struggling to stay on time.</li>
<li>During the rush, we introduced 2 bugs in the deployed smart contract (remember that a smart contract cannot be changed once it is deployed on the blockchain)</li>
<li>Taking inspiration from the Diamond architecture (EIP-2535), we found a solution by adding a new smart contract and linking them together.</li>
</ul>
<p>You can find the 2 smart contracts here:</p>
<ul>
<li><a href="https://etherscan.io/address/0xe95004c7f061577df60e9e46c1e724cc75b01850">Lenia NFT</a></li>
<li><a href="https://etherscan.io/address/0xb95e8487b8Df34f30e363681242b8d4a0661F785">Lenia Metadata</a></li>
</ul>
<h2>Back in time</h2>
<p>It&#x27;s Wednesday, September 22 2021. Alex and I had a call with the rest of the team (NfTribe). Everything is smooth so far, we feel confident in picking a date for the launch. We choose Thursday, October 7 2021, and take the time for the team to meet IRL. Traveling tickets are taken, everything is scheduled. Let&#x27;s go!</p>
<p>Fast forward 2 weeks. Alex and I are sleep-deprived, sweating, and writing code like some frenetic monkeys who don&#x27;t know what they are doing. Of course, the launch of the Lenia NFT collection must be done in pain, what did you expect?</p>
<p>But why though? Well, 2 weeks before the launch, when we decided the launch date, we hadn&#x27;t done a quite important step: estimating the gas of deploying our work on the Ethereum blockchain.
We finally did it only 10 days before, and this is when we discovered that we had to optimize many things to make the launch financially acceptable.</p>
<p>On top of that, we still had the website to finish, the smart contract to polish, and wanted to review all the Lenia color palettes. One thing after another, we finally review those color palettes just a few days before the launch. But then you have to render all the assets (it takes time), make sure the metadata and the assets are synchronized, shuffle them, etc.</p>
<p>So we end up rushing through those last-minute changes until we were ready. Focus is quite hard to summon at that point, remember that we are also sleep-deprived, stressed, and over-excited at the same time. During that work, the clock was ticking and we were already 30 minutes late!</p>
<p>Outside of the automated test, we did a final human check and then, we decided to deploy... without seeing that bugs were lurking... in a smart contract... which cannot be updated...</p>
<p><img src="./oups.gif" alt="Oups"/></p>
<h2>Bugs</h2>
<h3>Bug 1</h3>
<p>To optimize the overall cost of our smart contract, we decided to create a smart contract library with a lot of hardcoded values. This would allow us to pay once for the library and then be able to use it with a minimal amount of data for all the different Lenia. In doing so, we hardcoded the name of the color palettes.</p>
<p>But we changed some of those color palettes in the last few days, meaning some of them were removed and others were added. And we didn&#x27;t reflect the change in the <a href="https://etherscan.io/address/0xe95004c7f061577df60e9e46c1e724cc75b01850#code">smart contract library</a>, dooming the library to be unusable.</p>
<p>You can see below that the colors do not match the actual colors of the collection.
<img src="./colormap.png" alt="Hardcoded colormaps"/></p>
<p>BUT, we had enough room in the smart contract to circumvent the library and find a solution. At least, we thought until we discover the second bug.</p>
<h3>Bug 2</h3>
<p>Let me warn you, this one is fairly stupid.</p>
<p>While we were developing the smart contract, we were pondering the following feature: should we let owners update their Lenia metadata?</p>
<p>At first, it sounded cool but then we started to worry about bad actors which could start to point a Lenia to anything by changing its metadata. So we concluded to limit that feature to the Lenia smart contract owner.</p>
<p>A copy/paste action later, the little keyword <strong>onlyOwner</strong> was added to some of the smart contract functions. The goal was to protect the capacity to update those metadata not to limit access to it.</p>
<p>But this is what we did, this little keyword, <strong>onlyOwner</strong> ends up being added to the wrong function, the one which should be used to retrieve the data. We doomed another chance to solve our problem.
<img src="./metadata-2.png" alt="Hardcoded onlyOwner"/></p>
<h2>Hope</h2>
<p>In all those bad news, we still had done one thing well!</p>
<p>Putting Lenia on-chain requires two parts:</p>
<ul>
<li>The first one is to put Lenia data on-chain.</li>
<li>The second one is to upload the JavaScript rendering engine on-chain too.</li>
</ul>
<p>And we didn&#x27;t blow up that second part. This means that we had at least one field, which could be set by the owner and read by everyone inside our smart contract. üéâ</p>
<p>How to use that for our salvation?</p>
<h3>Taking inspiration from the best: EIP-2535</h3>
<p><a href="https://eips.ethereum.org/EIPS/eip-2535">EIP-2535 called &quot;Diamonds, Multi-Facet Proxy&quot;</a> describe a standard for building modular smart contract systems that can be extended (or updated) in production.</p>
<p>The best feature of this standard is the following: <strong>Diamonds can be upgraded without having to redeploy existing functionality. Parts of a diamond can be added/replaced/removed while leaving other parts alone.</strong></p>
<p>How does that work? The main contract is called a diamond and it contains external functions that are supplied by other independent smart contracts. The only thing you need to store in the diamond is the mapping of functions to the other smart contract.</p>
<p>This means that as long as you put your custom features outside of your main smart contract, you will be able to update them by deploying a new smart contract and updating the mapping of your diamond</p>
<p>And right here was the key for us. We won&#x27;t implement a diamond but we can use the same logic and use our free field to set the address of another smart contract!</p>
<h3>Metadata smart contract</h3>
<p>Following the diamond logic, we decided to create a new smart contract, and link our NFT contract to this new contract using the empty engine field.</p>
<p>We kept the new smart contract very concise to minimize errors, it only contains needed functions to store the rendering engine (Javascript) and Lenia metadata (JSON).</p>
<p>Just to be crystal clear, this is not following EIP-2535 but it&#x27;s perfectly fine for our use case üëç</p>
<h2>Why is it so important to be on-chain?</h2>
<p>Outside of purity and beauty consideration (Hi fellow nerds and hackers!). The main goal of being on-chain is to ensure that the data won&#x27;t disappear anywhere unless the chain itself disappears. Quite improbable for Ethereum now.</p>
<p>I believe this has a lot of value. It satisfies the promise of Ethereum itself: an immutable and timeless safe for your money, app, and data.</p>
<blockquote>
<p>Note: Since the data is quite big, it is currently stored as <code>callData</code>, meaning it&#x27;s in the logs of the blockchain. If you want to know more, come to speak with us in the discord!</p>
</blockquote>
<p>So did we alter anything?</p>
<ul>
<li>In terms of functionality, no. The data is stored as <code>callData</code> in the blockchain logs forever.</li>
<li>In terms of code beauty, yes. This is not beautiful and my little heart bleeds every time I&#x27;m looking at it.</li>
</ul>
<hr/>
<p>Hope you enjoyed this little &quot;behind the scene&quot; story! Have a nice day and take care!</p>
<p><img src="./cheers.gif" alt="Cheers"/></p></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-0CJ4XH940H"></script><script>
      
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='G-0CJ4XH940H',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-0CJ4XH940H', {"anonymize_ip":true,"cookie_expires":0,"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/on-chain/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d8b24e1cd75982f55a0c.js"],"app":["/app-7d6101fda03d10f602f8.js"],"component---src-pages-404-js":["/component---src-pages-404-js-bb99f688d8966bfa3b0e.js"],"component---src-pages-blog-index-js":["/component---src-pages-blog-index-js-e2a8fb75250054aab983.js"],"component---src-pages-blog-on-chain-js":["/component---src-pages-blog-on-chain-js-a342c2415ace82abdc8f.js"],"component---src-pages-embed-js":["/component---src-pages-embed-js-7f6586fe3400e1356d15.js"],"component---src-pages-generator-js":["/component---src-pages-generator-js-64dd8cab864fef8f0441.js"],"component---src-pages-generator-on-chain-js":["/component---src-pages-generator-on-chain-js-108a531d2023dc500055.js"],"component---src-pages-index-js":["/component---src-pages-index-js-9801072704a19a35a23f.js"]};/*]]>*/</script><script src="/polyfill-d8b24e1cd75982f55a0c.js" nomodule=""></script><script src="/component---src-pages-blog-on-chain-js-a342c2415ace82abdc8f.js" async=""></script><script src="/app-7d6101fda03d10f602f8.js" async=""></script><script src="/framework-01c4d90fe68c071f8f36.js" async=""></script><script src="/webpack-runtime-a49788a225b1cf65a998.js" async=""></script></body></html>